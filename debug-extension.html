<!DOCTYPE html>
<html>
  <head>
    <title>Debug Interview Co-Pilot Extension</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 40px;
      }
      .test-section {
        margin: 20px 0;
        padding: 20px;
        border: 1px solid #ccc;
      }
      button {
        margin: 10px;
        padding: 10px 20px;
        font-size: 16px;
      }
      .output {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        font-family: monospace;
      }
      .error {
        color: red;
      }
      .success {
        color: green;
      }
    </style>
  </head>
  <body>
    <h1>ü§ñ Interview Co-Pilot Extension Debug</h1>

    <div class="test-section">
      <h3>1. Extension Status</h3>
      <button onclick="checkExtension()">Check Extension Loaded</button>
      <div id="extension-status" class="output"></div>
    </div>

    <div class="test-section">
      <h3>2. Server Connection</h3>
      <button onclick="testServer()">Test Server Health</button>
      <button onclick="testAI()">Test AI Response</button>
      <div id="server-status" class="output"></div>
    </div>

    <div class="test-section">
      <h3>3. Speech Recognition</h3>
      <button onclick="testSpeech()">Test Speech API</button>
      <button onclick="simulateTranscript()">Simulate Transcript</button>
      <div id="speech-status" class="output"></div>
    </div>

    <div class="test-section">
      <h3>4. Socket.IO Connection</h3>
      <button onclick="testSocket()">Test WebSocket</button>
      <div id="socket-status" class="output"></div>
    </div>

    <div class="test-section">
      <h3>5. Extension Controls</h3>
      <button onclick="toggleOverlay()">Toggle Overlay</button>
      <button onclick="startListening()">Start Listening</button>
      <button onclick="stopListening()">Stop Listening</button>
      <div id="controls-status" class="output"></div>
    </div>

    <script>
      function log(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        const timestamp = new Date().toLocaleTimeString();
        const className =
          type === "error" ? "error" : type === "success" ? "success" : "";
        element.innerHTML += `<div class="${className}">[${timestamp}] ${message}</div>`;
      }

      function checkExtension() {
        log("extension-status", "Checking if extension is loaded...");

        // Check if overlay exists
        const overlay = document.querySelector("#interview-copilot-overlay");
        if (overlay) {
          log("extension-status", "‚úÖ Extension overlay found", "success");
          log(
            "extension-status",
            `Overlay visibility: ${overlay.style.display || "visible"}`,
            "success"
          );
        } else {
          log("extension-status", "‚ùå Extension overlay not found", "error");
        }

        // Check if content script is running
        if (window.interviewCopilot) {
          log(
            "extension-status",
            "‚úÖ Content script instance found",
            "success"
          );
          log(
            "extension-status",
            `Status: ${window.interviewCopilot.status || "unknown"}`,
            "success"
          );
        } else {
          log(
            "extension-status",
            "‚ùå Content script instance not found",
            "error"
          );
        }
      }

      async function testServer() {
        log("server-status", "Testing server health...");
        try {
          const response = await fetch("http://localhost:3001/health");
          const data = await response.json();
          log(
            "server-status",
            `‚úÖ Server healthy: ${JSON.stringify(data)}`,
            "success"
          );
        } catch (error) {
          log("server-status", `‚ùå Server error: ${error.message}`, "error");
        }
      }

      async function testAI() {
        log("server-status", "Testing AI response generation...");
        try {
          const response = await fetch(
            "http://localhost:3001/api/generate-answer",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                question: "Tell me about yourself",
                context: "Software engineering interview",
              }),
            }
          );
          const data = await response.json();
          log(
            "server-status",
            `‚úÖ AI response: ${data.answer.substring(0, 100)}...`,
            "success"
          );
        } catch (error) {
          log("server-status", `‚ùå AI error: ${error.message}`, "error");
        }
      }

      function testSpeech() {
        log("speech-status", "Testing Speech Recognition API...");

        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          log("speech-status", "‚ùå Speech Recognition not supported", "error");
          return;
        }

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.onstart = () => {
          log("speech-status", "‚úÖ Speech recognition started", "success");
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          const confidence = event.results[0][0].confidence;
          log(
            "speech-status",
            `‚úÖ Recognized: "${transcript}" (${(confidence * 100).toFixed(
              1
            )}%)`,
            "success"
          );
        };

        recognition.onerror = (event) => {
          log("speech-status", `‚ùå Speech error: ${event.error}`, "error");
        };

        try {
          recognition.start();
          log("speech-status", "Say something in the next 5 seconds...");
        } catch (error) {
          log("speech-status", `‚ùå Failed to start: ${error.message}`, "error");
        }
      }

      function simulateTranscript() {
        log("speech-status", "Simulating transcript...");
        if (window.interviewCopilot) {
          // Simulate speech recognition result
          const mockTranscript =
            "Tell me about your experience with JavaScript";
          log("speech-status", `Simulating: "${mockTranscript}"`);

          // Try to call the extension's transcript handler
          if (window.interviewCopilot.processTranscript) {
            window.interviewCopilot.processTranscript(mockTranscript, 0.95);
            log(
              "speech-status",
              "‚úÖ Sent to extension for processing",
              "success"
            );
          } else {
            log(
              "speech-status",
              "‚ùå Extension processTranscript method not found",
              "error"
            );
          }
        } else {
          log("speech-status", "‚ùå Extension not available", "error");
        }
      }

      function testSocket() {
        log("socket-status", "Testing Socket.IO connection...");

        // Try to connect directly to server
        const script = document.createElement("script");
        script.src = "https://cdn.socket.io/4.7.2/socket.io.min.js";
        script.onload = () => {
          try {
            const socket = io("http://localhost:3001");

            socket.on("connect", () => {
              log(
                "socket-status",
                "‚úÖ Socket.IO connected directly",
                "success"
              );

              // Test transcription
              socket.emit("transcription", {
                text: "Test question from debug page",
                context: "debugging",
                timestamp: new Date().toISOString(),
                confidence: 1.0,
              });
              log("socket-status", "Sent test transcription...");
            });

            socket.on("answer", (data) => {
              log(
                "socket-status",
                `‚úÖ Received AI answer: ${data.answer.substring(0, 100)}...`,
                "success"
              );
              socket.disconnect();
            });

            socket.on("connect_error", (error) => {
              log(
                "socket-status",
                `‚ùå Socket connection error: ${error.message}`,
                "error"
              );
            });
          } catch (error) {
            log(
              "socket-status",
              `‚ùå Socket test error: ${error.message}`,
              "error"
            );
          }
        };
        script.onerror = () => {
          log("socket-status", "‚ùå Failed to load Socket.IO library", "error");
        };
        document.head.appendChild(script);
      }

      function toggleOverlay() {
        if (window.interviewCopilot) {
          const overlay = document.querySelector("#interview-copilot-overlay");
          if (overlay) {
            overlay.style.display =
              overlay.style.display === "none" ? "block" : "none";
            log(
              "controls-status",
              `Overlay toggled: ${overlay.style.display}`,
              "success"
            );
          } else {
            log("controls-status", "‚ùå Overlay not found", "error");
          }
        } else {
          log("controls-status", "‚ùå Extension not available", "error");
        }
      }

      function startListening() {
        if (window.interviewCopilot && window.interviewCopilot.startListening) {
          window.interviewCopilot.startListening();
          log("controls-status", "‚úÖ Started listening", "success");
        } else {
          log(
            "controls-status",
            "‚ùå Extension startListening not available",
            "error"
          );
        }
      }

      function stopListening() {
        if (window.interviewCopilot && window.interviewCopilot.stopListening) {
          window.interviewCopilot.stopListening();
          log("controls-status", "‚úÖ Stopped listening", "success");
        } else {
          log(
            "controls-status",
            "‚ùå Extension stopListening not available",
            "error"
          );
        }
      }

      // Auto-check extension on page load
      window.addEventListener("load", () => {
        setTimeout(() => {
          checkExtension();
          testServer();
        }, 2000);
      });

      // Monitor console for extension messages
      const originalLog = console.log;
      console.log = function (...args) {
        originalLog.apply(console, args);
        if (
          args[0] &&
          typeof args[0] === "string" &&
          args[0].includes("Interview Co-Pilot")
        ) {
          log("extension-status", "Console: " + args.join(" "));
        }
      };
    </script>
  </body>
</html>
