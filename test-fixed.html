<!DOCTYPE html>
<html>
  <head>
    <title>ü§ñ Interview Co-Pilot - Fixed Version Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: white;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        padding: 30px;
        border-radius: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }
      h1 {
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
      }
      .status-card {
        background: rgba(255, 255, 255, 0.1);
        border-radius: 15px;
        padding: 20px;
        margin: 20px 0;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }
      .status-header {
        font-size: 1.2em;
        font-weight: bold;
        margin-bottom: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .status-indicator {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        display: inline-block;
      }
      .status-success {
        background: #4caf50;
      }
      .status-error {
        background: #f44336;
      }
      .status-warning {
        background: #ff9800;
      }
      .status-info {
        background: #2196f3;
      }

      button {
        padding: 12px 24px;
        margin: 10px 5px;
        font-size: 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
        background: rgba(255, 255, 255, 0.2);
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.3);
      }
      button:hover {
        background: rgba(255, 255, 255, 0.3);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      }
      .btn-success {
        background: rgba(76, 175, 80, 0.8);
      }
      .btn-error {
        background: rgba(244, 67, 54, 0.8);
      }
      .btn-info {
        background: rgba(33, 150, 243, 0.8);
      }

      .output {
        background: rgba(0, 0, 0, 0.4);
        padding: 15px;
        margin: 15px 0;
        border-radius: 8px;
        font-family: "Courier New", monospace;
        white-space: pre-wrap;
        max-height: 300px;
        overflow-y: auto;
        font-size: 14px;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }
      .test-section {
        margin: 25px 0;
      }
      .extension-overlay-demo {
        position: fixed;
        top: 20px;
        right: 20px;
        width: 380px;
        background: rgba(0, 0, 0, 0.9);
        color: white;
        border-radius: 12px;
        padding: 15px;
        z-index: 10000;
        font-family: inherit;
        font-size: 14px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ü§ñ Interview Co-Pilot - Fixed Version</h1>

      <div class="status-card">
        <div class="status-header">
          <span class="status-indicator status-info" id="overall-status"></span>
          System Status
        </div>
        <div id="system-status">Checking system status...</div>
      </div>

      <div class="test-section">
        <div class="status-card">
          <div class="status-header">
            <span
              class="status-indicator status-warning"
              id="server-status"
            ></span>
            Server Connection
          </div>
          <button class="btn-info" onclick="testServer()">
            üîç Test Server
          </button>
          <button class="btn-info" onclick="testAI()">ü§ñ Test AI</button>
          <div id="server-output" class="output">
            Click "Test Server" to check backend...
          </div>
        </div>
      </div>

      <div class="test-section">
        <div class="status-card">
          <div class="status-header">
            <span
              class="status-indicator status-warning"
              id="extension-status"
            ></span>
            Extension (New Fetch Version)
          </div>
          <button class="btn-success" onclick="testExtension()">
            üîç Check Extension
          </button>
          <button class="btn-info" onclick="simulateAI()">
            üéØ Simulate AI Request
          </button>
          <button class="btn-info" onclick="showOverlay()">
            üëÅÔ∏è Show Overlay
          </button>
          <div id="extension-output" class="output">
            Extension status will appear here...
          </div>
        </div>
      </div>

      <div class="test-section">
        <div class="status-card">
          <div class="status-header">
            <span
              class="status-indicator status-warning"
              id="speech-status"
            ></span>
            Speech Recognition
          </div>
          <button class="btn-info" onclick="testSpeech()">
            üé§ Test Speech
          </button>
          <button class="btn-success" onclick="startListening()">
            üî¥ Start Listening
          </button>
          <div id="speech-output" class="output">
            Speech recognition not tested...
          </div>
        </div>
      </div>

      <div class="test-section">
        <div class="status-card">
          <div class="status-header">Manual AI Test</div>
          <input
            type="text"
            id="manual-question"
            placeholder="Ask a test question..."
            style="
              width: 70%;
              padding: 10px;
              margin-right: 10px;
              border-radius: 6px;
              border: 1px solid rgba(255, 255, 255, 0.3);
              background: rgba(255, 255, 255, 0.1);
              color: white;
            "
          />
          <button class="btn-success" onclick="manualTest()">üí¨ Send</button>
          <div id="manual-output" class="output">Enter a question above...</div>
        </div>
      </div>
    </div>

    <!-- Demo overlay -->
    <div class="extension-overlay-demo" id="demo-overlay">
      <div
        style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 10px;
        "
      >
        <span style="font-weight: bold">ü§ñ Interview Co-Pilot</span>
        <button
          onclick="hideOverlay()"
          style="
            background: #f44336;
            border: none;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
          "
        >
          √ó
        </button>
      </div>
      <div
        style="
          background: rgba(0, 150, 255, 0.1);
          padding: 10px;
          border-radius: 6px;
        "
      >
        <div style="font-size: 12px; color: #ccc; margin-bottom: 5px">
          ü§ñ AI Response:
        </div>
        <div id="demo-response">
          This is how the overlay will look during interviews!
        </div>
      </div>
      <div
        style="
          margin-top: 10px;
          font-size: 12px;
          color: #888;
          text-align: center;
        "
      >
        Ready (No Socket.IO) ‚úÖ
      </div>
    </div>

    <script>
      let extensionLoaded = false;

      function updateStatus(elementId, status, type = "info") {
        const indicator = document.getElementById(elementId);
        if (indicator) {
          indicator.className = `status-indicator status-${type}`;
        }
      }

      function log(elementId, message, type = "info") {
        const element = document.getElementById(elementId);
        const timestamp = new Date().toLocaleTimeString();
        const icon =
          type === "error"
            ? "‚ùå"
            : type === "success"
            ? "‚úÖ"
            : type === "warning"
            ? "‚ö†Ô∏è"
            : "üìù";
        element.textContent += `[${timestamp}] ${icon} ${message}\n`;
        element.scrollTop = element.scrollHeight;
      }

      async function testServer() {
        log("server-output", "Testing server health...");
        try {
          const response = await fetch("http://localhost:3001/health");
          if (response.ok) {
            const data = await response.json();
            log("server-output", `Server healthy: ${data.status}`, "success");
            updateStatus("server-status", "success", "success");
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          log("server-output", `Server error: ${error.message}`, "error");
          updateStatus("server-status", "error", "error");
        }
      }

      async function testAI() {
        log("server-output", "Testing AI endpoint...");
        try {
          const response = await fetch(
            "http://localhost:3001/api/generate-answer",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                question: "What is React?",
                context: "Frontend interview test",
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            log(
              "server-output",
              `AI Response: ${data.answer.substring(0, 100)}...`,
              "success"
            );
          } else {
            throw new Error(`HTTP ${response.status}`);
          }
        } catch (error) {
          log("server-output", `AI error: ${error.message}`, "error");
        }
      }

      function testExtension() {
        log("extension-output", "Checking for extension...");

        // Check if overlay exists
        const overlay = document.querySelector("#interview-copilot-overlay");
        if (overlay) {
          log("extension-output", "Extension overlay found!", "success");
          updateStatus("extension-status", "success", "success");
          extensionLoaded = true;
        } else {
          log("extension-output", "Extension overlay not found", "warning");
          updateStatus("extension-status", "warning", "warning");
        }

        // Check for global object
        if (window.interviewCopilot) {
          log(
            "extension-output",
            `Extension instance found: ${window.interviewCopilot.status}`,
            "success"
          );
          extensionLoaded = true;
        } else {
          log("extension-output", "Extension instance not found", "warning");
          log(
            "extension-output",
            "Make sure extension is loaded in Chrome",
            "warning"
          );
        }
      }

      async function simulateAI() {
        if (!extensionLoaded && !window.interviewCopilot) {
          log(
            "extension-output",
            "Extension not loaded - testing fetch directly...",
            "warning"
          );

          try {
            const response = await fetch(
              "http://localhost:3001/api/generate-answer",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  question: "Tell me about your JavaScript experience",
                  context: "Technical interview simulation",
                }),
              }
            );

            const data = await response.json();
            log(
              "extension-output",
              `Direct AI Test: ${data.answer.substring(0, 150)}...`,
              "success"
            );
            updateStatus("extension-status", "success", "success");
          } catch (error) {
            log(
              "extension-output",
              `Direct test failed: ${error.message}`,
              "error"
            );
          }
          return;
        }

        log("extension-output", "Simulating AI request through extension...");
        if (window.interviewCopilot && window.interviewCopilot.sendToAI) {
          try {
            await window.interviewCopilot.sendToAI(
              "What are closures in JavaScript?"
            );
            log("extension-output", "AI request sent successfully!", "success");
          } catch (error) {
            log(
              "extension-output",
              `Simulation error: ${error.message}`,
              "error"
            );
          }
        } else {
          log(
            "extension-output",
            "Extension sendToAI method not available",
            "error"
          );
        }
      }

      function testSpeech() {
        log("speech-output", "Testing speech recognition...");

        if (
          !("webkitSpeechRecognition" in window) &&
          !("SpeechRecognition" in window)
        ) {
          log("speech-output", "Speech Recognition not supported", "error");
          updateStatus("speech-status", "error", "error");
          return;
        }

        log("speech-output", "Speech Recognition API available", "success");
        updateStatus("speech-status", "success", "success");

        const SpeechRecognition =
          window.SpeechRecognition || window.webkitSpeechRecognition;
        const recognition = new SpeechRecognition();

        recognition.onstart = () => {
          log("speech-output", "Listening... (speak now)", "success");
        };

        recognition.onresult = (event) => {
          const transcript = event.results[0][0].transcript;
          log("speech-output", `Heard: "${transcript}"`, "success");
        };

        recognition.onerror = (event) => {
          log("speech-output", `Speech error: ${event.error}`, "error");
        };

        recognition.start();
      }

      function startListening() {
        if (window.interviewCopilot && window.interviewCopilot.startListening) {
          window.interviewCopilot.startListening();
          log("speech-output", "Extension listening started", "success");
        } else {
          log(
            "speech-output",
            "Extension not available for listening",
            "error"
          );
        }
      }

      async function manualTest() {
        const question = document
          .getElementById("manual-question")
          .value.trim();
        if (!question) {
          log("manual-output", "Please enter a question", "warning");
          return;
        }

        log("manual-output", `Testing: "${question}"`);

        try {
          const response = await fetch(
            "http://localhost:3001/api/generate-answer",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                question: question,
                context: "Manual test from debug page",
              }),
            }
          );

          const data = await response.json();
          log("manual-output", `AI: ${data.answer}`, "success");

          // Update demo overlay
          document.getElementById("demo-response").textContent =
            data.answer.substring(0, 200) + "...";
        } catch (error) {
          log("manual-output", `Error: ${error.message}`, "error");
        }
      }

      function showOverlay() {
        document.getElementById("demo-overlay").style.display = "block";
        log("extension-output", "Demo overlay shown", "success");
      }

      function hideOverlay() {
        document.getElementById("demo-overlay").style.display = "none";
      }

      // Auto-check on page load
      window.addEventListener("load", () => {
        setTimeout(() => {
          testServer();
          testExtension();
          document.getElementById("system-status").textContent =
            "System initialized. Ready for testing.";
          updateStatus("overall-status", "success", "success");
        }, 1000);
      });

      // Check for extension every few seconds
      setInterval(() => {
        if (!extensionLoaded && !window.interviewCopilot) {
          testExtension();
        }
      }, 5000);
    </script>
  </body>
</html>
